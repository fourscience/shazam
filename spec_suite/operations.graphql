# Fragments to maximize reuse
fragment UserPreview on User {
  id
  name
  role
}

fragment UserFull on User {
  ...UserPreview
  bio
  friends {
    ...UserPreview
  }
  favoritePost {
    ...PostPreview
  }
  posts {
    ...PostPreview
  }
}

fragment PostPreview on Post {
  id
  title
  author {
    ...UserPreview
  }
}

fragment CommentWithAuthor on Comment {
  id
  body
  author {
    ...UserPreview
  }
  replies {
    id
    body
  }
}

fragment PostFull on Post {
  ...PostPreview
  tags
  metadata {
    isPublished
    rating
    createdAt
  }
  stats {
    views
    likes
    reactions
  }
  comments {
    ...CommentWithAuthor
  }
  likedBy {
    ...UserPreview
  }
}

# Queries
query GetUserAndSearch($id: ID!, $term: String!, $withComments: Boolean! = true) {
  user(id: $id) {
    ...UserFull
  }
  search(term: $term) {
    __typename
    ... on User {
      ...UserPreview
    }
    ... on Post {
      ...PostPreview
    }
    ... on Comment {
      ...CommentWithAuthor
    }
  }
  posts(limit: 5) {
    ...PostFull
    comments @include(if: $withComments) {
      ...CommentWithAuthor
    }
  }
}

# Mutations
mutation CreatePost($input: PostInput!) {
  createPost(input: $input) {
    ...PostFull
  }
}

mutation ToggleLike($id: ID!, $on: Boolean = true) {
  toggleLike(id: $id, on: $on) {
    success
    target {
      __typename
      ... on Post {
        id
        title
        stats {
          likes
          reactions
        }
      }
      ... on Comment {
        id
        body
        author {
          name
        }
      }
      ... on User {
        id
        name
      }
    }
  }
}

# Subscriptions
subscription OnPostAdded {
  postAdded {
    ...PostPreview
  }
}

subscription OnActivity {
  activity {
    __typename
    ... on Post {
      ...PostPreview
    }
    ... on Comment {
      ...CommentWithAuthor
    }
  }
}
